name: QA E2E CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  #################################
  # Bazel Unit Tests
  #################################
  bazel-unit-tests:
    name: Unit Tests (Bazel)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Bazel
        uses: bazelbuild/setup-bazelisk@v3

      - name: Run Bazel tests
        working-directory: Bazel_gtest_unit_tests
        run: |
          bazel test //tests:math_utils_test --test_output=all

  #################################
  # CMake + GTest
  #################################
  gtest-unit-tests:
    name: Unit Tests (GTest + CMake)
    runs-on: ubuntu-latest
    needs: bazel-unit-tests

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential
          pip install gcovr

      - name: Run GTest + Coverage
        working-directory: Unit_tests_gtest
        run: |
          chmod +x scripts/run_tests.sh
          ./scripts/run_tests.sh

      - name: Upload GTest reports
        uses: actions/upload-artifact@v4
        with:
          name: gtest-reports
          path: Bazel_gtest_unit_tests/reports/gtest

  #################################
  # API Tests
  #################################
  api-tests:
    name: API Tests (Postman + Newman)
    runs-on: ubuntu-latest
    needs: gtest-unit-tests

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Newman
        run: npm install -g newman

      - name: Run API tests
        run: |
          newman run API_Tests/postman_collection.json \
            -e API_Tests/postman_environment.json

  #################################
  # UI Tests
  #################################
  ui-tests:
    name: UI Tests (Selenium + TestNG)
    runs-on: ubuntu-latest
    needs: api-tests

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Run UI tests
        working-directory: UI_Tests
        run: mvn clean test

      - name: Upload UI test reports
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-reports
          path: UI_Tests/target/surefire-reports
